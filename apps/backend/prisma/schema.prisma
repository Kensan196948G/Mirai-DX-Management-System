// CDCP Database Schema
// PostgreSQL 15 + PostGIS

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis(version: "3.3"), pg_trgm, pgcrypto, uuidOssp(map: "uuid-ossp")]
}

// ========================================
// 組織・ユーザー管理
// ========================================

model Organization {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name      String   @db.VarChar(200)
  code      String   @unique @db.VarChar(20)
  type      OrgType
  parentId  String?  @map("parent_id") @db.Uuid
  parent    Organization?  @relation("OrgHierarchy", fields: [parentId], references: [id])
  children  Organization[] @relation("OrgHierarchy")
  address   String?  @db.Text
  tel       String?  @db.VarChar(20)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  users     User[]
  projects  Project[]

  @@index([parentId])
  @@index([isActive])
  @@map("organizations")
}

enum OrgType {
  HQ         @map("本社")
  BRANCH     @map("支店")
  OFFICE     @map("営業所")

  @@map("org_type")
}

model User {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  auth0UserId    String    @unique @map("auth0_user_id") @db.VarChar(100)
  email          String    @unique @db.VarChar(255)
  name           String    @db.VarChar(100)
  organizationId String    @map("organization_id") @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id])
  employeeCode   String?   @map("employee_code") @db.VarChar(20)
  isActive       Boolean   @default(true) @map("is_active")
  lastLoginAt    DateTime? @map("last_login_at") @db.Timestamp
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  roles                  UserRole[]
  supervisedProjects     Project[]          @relation("ProjectSupervisor")
  createdProjects        Project[]          @relation("ProjectCreator")
  projectMemberships     ProjectMember[]
  uploadedPhotos         Photo[]            @relation("PhotoUploader")
  photoComments          PhotoComment[]
  createdFolders         PhotoFolder[]
  scheduleProgresses     ScheduleProgress[]
  recordedCostBudgets    CostBudget[]
  recordedCostActuals    CostActual[]
  auditLogs              AuditLog[]

  @@index([organizationId])
  @@index([email])
  @@index([isActive])
  @@map("users")
}

model Role {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        RoleName @unique
  displayName String   @map("display_name") @db.VarChar(100)
  description String?  @db.Text
  permissions Json     @default("[]") @db.JsonB
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  users UserRole[]

  @@map("roles")
}

enum RoleName {
  SYSTEM_ADMIN @map("system_admin")
  BRANCH_ADMIN @map("branch_admin")
  SUPERVISOR   @map("supervisor")
  WORKER       @map("worker")
  VIEWER       @map("viewer")

  @@map("role_name")
}

model UserRole {
  userId    String   @map("user_id") @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String   @map("role_id") @db.Uuid
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp

  @@id([userId, roleId])
  @@map("user_roles")
}

// ========================================
// 案件管理
// ========================================

model Project {
  id              String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  code            String       @unique @db.VarChar(50)
  name            String       @db.VarChar(200)
  clientName      String       @map("client_name") @db.VarChar(200)
  clientType      ClientType   @map("client_type")
  constructionType String      @map("construction_type") @db.VarChar(50)
  location        String?      @db.VarChar(500)
  locationPoint   String?      @map("location_point") @db.Text // Geography(Point, 4326)
  contractAmount  Decimal?     @map("contract_amount") @db.Decimal(15, 2)
  startDate       DateTime     @map("start_date") @db.Date
  endDate         DateTime     @map("end_date") @db.Date
  actualEndDate   DateTime?    @map("actual_end_date") @db.Date
  status          ProjectStatus @default(PREPARING)
  organizationId  String       @map("organization_id") @db.Uuid
  organization    Organization @relation(fields: [organizationId], references: [id])
  supervisorId    String       @map("supervisor_id") @db.Uuid
  supervisor      User         @relation("ProjectSupervisor", fields: [supervisorId], references: [id])
  createdBy       String       @map("created_by") @db.Uuid
  creator         User         @relation("ProjectCreator", fields: [createdBy], references: [id])
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamp
  updatedAt       DateTime     @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  members      ProjectMember[]
  photos       Photo[]
  photoFolders PhotoFolder[]
  photoTags    PhotoTag[]
  schedules    Schedule[]
  costBudgets  CostBudget[]
  costActuals  CostActual[]

  @@index([organizationId])
  @@index([supervisorId])
  @@index([status])
  @@index([startDate])
  @@map("projects")
}

enum ClientType {
  PUBLIC  @map("公共")
  PRIVATE @map("民間")

  @@map("client_type")
}

enum ProjectStatus {
  PREPARING    @map("準備中")
  IN_PROGRESS  @map("施工中")
  COMPLETED    @map("完成")
  CANCELLED    @map("中止")

  @@map("project_status")
}

model ProjectMember {
  projectId  String         @map("project_id") @db.Uuid
  project    Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId     String         @map("user_id") @db.Uuid
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       ProjectMemberRole
  assignedAt DateTime       @default(now()) @map("assigned_at") @db.Timestamp

  @@id([projectId, userId])
  @@map("project_members")
}

enum ProjectMemberRole {
  SUPERVISOR    @map("監督")
  WORKER        @map("作業員")
  PARTNER       @map("協力会社")
  VIEWER        @map("閲覧")

  @@map("project_member_role")
}

// ========================================
// 写真管理（Phase1）
// ========================================

model Photo {
  id               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId        String    @map("project_id") @db.Uuid
  project          Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  folderId         String?   @map("folder_id") @db.Uuid
  folder           PhotoFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  fileName         String    @map("file_name") @db.VarChar(500)
  s3Key            String    @unique @map("s3_key") @db.VarChar(1000)
  thumbnailS3Key   String?   @map("thumbnail_s3_key") @db.VarChar(1000)
  fileSize         BigInt    @map("file_size")
  mimeType         String    @map("mime_type") @db.VarChar(100)
  width            Int?
  height           Int?
  takenAt          DateTime  @map("taken_at") @db.Timestamp
  locationPoint    String?   @map("location_point") @db.Text // Geography(Point, 4326)
  locationAddress  String?   @map("location_address") @db.VarChar(500)
  deviceInfo       Json?     @map("device_info") @db.JsonB
  exifData         Json?     @map("exif_data") @db.JsonB
  uploadedBy       String    @map("uploaded_by") @db.Uuid
  uploader         User      @relation("PhotoUploader", fields: [uploadedBy], references: [id])
  uploadedAt       DateTime  @default(now()) @map("uploaded_at") @db.Timestamp
  isDeleted        Boolean   @default(false) @map("is_deleted")
  deletedAt        DateTime? @map("deleted_at") @db.Timestamp
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  tags     PhotoTagRelation[]
  comments PhotoComment[]

  @@index([projectId])
  @@index([folderId])
  @@index([takenAt])
  @@index([uploadedBy])
  @@index([isDeleted])
  @@map("photos")
}

model PhotoFolder {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId   String    @map("project_id") @db.Uuid
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentId    String?   @map("parent_id") @db.Uuid
  parent      PhotoFolder? @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    PhotoFolder[] @relation("FolderHierarchy")
  name        String    @db.VarChar(200)
  description String?   @db.Text
  sortOrder   Int       @default(0) @map("sort_order")
  createdBy   String    @map("created_by") @db.Uuid
  creator     User      @relation(fields: [createdBy], references: [id])
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  photos Photo[]

  @@unique([projectId, parentId, name])
  @@index([projectId])
  @@index([parentId])
  @@map("photo_folders")
}

model PhotoTag {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name      String   @db.VarChar(100)
  color     String   @default("#3f51b5") @db.VarChar(7)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp

  // Relations
  photos PhotoTagRelation[]

  @@unique([projectId, name])
  @@map("photo_tags")
}

model PhotoTagRelation {
  photoId   String   @map("photo_id") @db.Uuid
  photo     Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)
  tagId     String   @map("tag_id") @db.Uuid
  tag       PhotoTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp

  @@id([photoId, tagId])
  @@map("photo_tag_relations")
}

model PhotoComment {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  photoId   String   @map("photo_id") @db.Uuid
  photo     Photo    @relation(fields: [photoId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id") @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  comment   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp

  @@index([photoId])
  @@index([userId])
  @@map("photo_comments")
}

// ========================================
// 工程管理（Phase2）
// ========================================

model Schedule {
  id              String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId       String     @map("project_id") @db.Uuid
  project         Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentId        String?    @map("parent_id") @db.Uuid
  parent          Schedule?  @relation("ScheduleHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children        Schedule[] @relation("ScheduleHierarchy")
  name            String     @db.VarChar(200)
  code            String?    @db.VarChar(50)
  level           Int        @default(1)
  startDate       DateTime   @map("start_date") @db.Date
  endDate         DateTime   @map("end_date") @db.Date
  actualStartDate DateTime?  @map("actual_start_date") @db.Date
  actualEndDate   DateTime?  @map("actual_end_date") @db.Date
  progressRate    Decimal    @default(0) @map("progress_rate") @db.Decimal(5, 2)
  isCriticalPath  Boolean    @default(false) @map("is_critical_path")
  sortOrder       Int        @default(0) @map("sort_order")
  createdAt       DateTime   @default(now()) @map("created_at") @db.Timestamp
  updatedAt       DateTime   @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  progresses ScheduleProgress[]

  @@index([projectId])
  @@index([parentId])
  @@index([startDate])
  @@map("schedules")
}

model ScheduleProgress {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  scheduleId   String   @map("schedule_id") @db.Uuid
  schedule     Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  recordedDate DateTime @map("recorded_date") @db.Date
  progressRate Decimal  @map("progress_rate") @db.Decimal(5, 2)
  weather      String?  @db.VarChar(50)
  workerCount  Int?     @map("worker_count")
  memo         String?  @db.Text
  recordedBy   String   @map("recorded_by") @db.Uuid
  recorder     User     @relation(fields: [recordedBy], references: [id])
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp

  @@unique([scheduleId, recordedDate])
  @@index([scheduleId])
  @@index([recordedDate])
  @@map("schedule_progresses")
}

// ========================================
// 原価管理（Phase2）
// ========================================

model CostBudget {
  id           String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId    String       @map("project_id") @db.Uuid
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  category     CostCategory
  subCategory  String?      @map("sub_category") @db.VarChar(100)
  budgetAmount Decimal      @map("budget_amount") @db.Decimal(15, 2)
  description  String?      @db.Text
  createdBy    String       @map("created_by") @db.Uuid
  creator      User         @relation(fields: [createdBy], references: [id])
  createdAt    DateTime     @default(now()) @map("created_at") @db.Timestamp
  updatedAt    DateTime     @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  actuals CostActual[]

  @@index([projectId])
  @@index([category])
  @@map("cost_budgets")
}

model CostActual {
  id              String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId       String       @map("project_id") @db.Uuid
  project         Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  budgetId        String?      @map("budget_id") @db.Uuid
  budget          CostBudget?  @relation(fields: [budgetId], references: [id], onDelete: SetNull)
  category        CostCategory
  subCategory     String?      @map("sub_category") @db.VarChar(100)
  actualAmount    Decimal      @map("actual_amount") @db.Decimal(15, 2)
  actualDate      DateTime     @map("actual_date") @db.Date
  vendorName      String?      @map("vendor_name") @db.VarChar(200)
  invoiceNumber   String?      @map("invoice_number") @db.VarChar(100)
  description     String?      @db.Text
  attachmentS3Key String?      @map("attachment_s3_key") @db.VarChar(1000)
  recordedBy      String       @map("recorded_by") @db.Uuid
  recorder        User         @relation(fields: [recordedBy], references: [id])
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamp
  updatedAt       DateTime     @updatedAt @map("updated_at") @db.Timestamp

  @@index([projectId])
  @@index([budgetId])
  @@index([actualDate])
  @@index([category])
  @@map("cost_actuals")
}

enum CostCategory {
  MATERIAL  @map("材料費")
  LABOR     @map("労務費")
  OUTSOURCE @map("外注費")
  EXPENSE   @map("経費")

  @@map("cost_category")
}

// ========================================
// 監査ログ
// ========================================

model AuditLog {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String   @db.VarChar(100)
  entityType String   @map("entity_type") @db.VarChar(100)
  entityId   String?  @map("entity_id") @db.Uuid
  changes    Json?    @db.JsonB
  ipAddress  String?  @map("ip_address") @db.Inet
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}
