# システムアーキテクチャ設計書 (System Architecture Design)

## 1. 文書概要

### 1.1 目的
本文書は、CDCP（Construction Digital Control Platform）のシステムアーキテクチャを定義し、技術選定の根拠、構成要素、非機能要件の実現方法を明確化する。

### 1.2 対象読者
- プロジェクトチーム全体
- 開発ベンダー
- IT部門
- インフラ担当者

### 1.3 前提条件
- **対象企業**: 従業員550名、IT部門5名
- **運用方針**: クラウドマネージドサービス優先、IT部門負荷最小化
- **予算**: Phase1-3合計 9,720万円
- **期間**: 18ヶ月

---

## 2. アーキテクチャ方針

### 2.1 設計原則

| 原則 | 内容 | 理由 |
|------|------|------|
| **クラウドネイティブ** | AWS完全活用、サーバーレス優先 | 運用負荷最小化 |
| **マネージドサービス優先** | RDS、S3、Lambda等の活用 | IT部門5名での運用実現 |
| **スケーラビリティ** | 水平スケール可能な設計 | 550名→将来拡張対応 |
| **セキュリティファースト** | 多層防御、最小権限原則 | 企業データ保護 |
| **高可用性** | Multi-AZ、自動復旧 | 現場業務停止回避 |
| **コスト最適化** | 従量課金、Auto Scaling | 予算制約内での実現 |

### 2.2 技術選定基準

| 基準 | 重み | 評価項目 |
|------|------|---------|
| **運用性** | 40% | マネージド度合い、自動化容易性 |
| **コスト** | 30% | 初期費用、ランニングコスト |
| **実績・信頼性** | 20% | 導入実績、コミュニティ |
| **拡張性** | 10% | 将来要件への対応力 |

---

## 3. システム全体像

### 3.1 論理アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        クライアント層                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐              │
│  │ Web (PWA) │  │  Mobile  │  │ 顧客ポータル  │              │
│  │  (社内)   │  │  (現場)  │  │  (Phase3)    │              │
│  └─────┬────┘  └────┬─────┘  └──────┬───────┘              │
└────────┼─────────────┼────────────────┼───────────────────┘
         │             │                │
         └─────────────┴────────────────┘
                       │ HTTPS (TLS 1.3)
         ┌─────────────▼────────────────┐
         │      CloudFront (CDN)         │
         └─────────────┬────────────────┘
                       │
┌──────────────────────▼─────────────────────────────────────┐
│                    アプリケーション層                        │
│  ┌──────────────────────────────────────────────────┐      │
│  │            ALB (Application Load Balancer)        │      │
│  └──────────┬───────────────────────┬─────────────┘       │
│             │                       │                       │
│    ┌────────▼────────┐     ┌───────▼────────┐             │
│    │  ECS Fargate    │     │  Lambda         │             │
│    │  (API Server)   │     │  (非同期処理)   │             │
│    │  - NestJS       │     │  - 画像処理     │             │
│    │  - TypeScript   │     │  - レポート生成  │             │
│    └────────┬────────┘     └───────┬────────┘             │
└─────────────┼──────────────────────┼───────────────────────┘
              │                      │
┌─────────────▼──────────────────────▼───────────────────────┐
│                        データ層                              │
│  ┌─────────────┐  ┌──────────┐  ┌─────────────┐          │
│  │  RDS (主DB)  │  │ ElastiCache│ │   S3 (写真) │          │
│  │  PostgreSQL  │  │   Redis    │  │ + CloudFront│          │
│  │  Multi-AZ    │  │            │  │             │          │
│  └─────────────┘  └──────────┘  └─────────────┘          │
└───────────────────────────────────────────────────────────┘
              │
┌─────────────▼───────────────────────────────────────────────┐
│                    外部サービス層                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐            │
│  │  Auth0   │  │ Datadog  │  │  Sentry       │            │
│  │  (認証)  │  │ (監視)   │  │ (エラー追跡)  │            │
│  └──────────┘  └──────────┘  └──────────────┘            │
└───────────────────────────────────────────────────────────┘
```

### 3.2 物理アーキテクチャ（AWS構成）

```
┌─────────────────────── AWS Cloud ─────────────────────────┐
│                                                             │
│  ┌───────────── VPC (10.0.0.0/16) ──────────────┐         │
│  │                                                │         │
│  │  ┌──── Availability Zone A ────┐              │         │
│  │  │                              │              │         │
│  │  │  ┌─── Public Subnet ────┐   │              │         │
│  │  │  │  - NAT Gateway       │   │              │         │
│  │  │  │  - ALB               │   │              │         │
│  │  │  └──────────────────────┘   │              │         │
│  │  │                              │              │         │
│  │  │  ┌─── Private Subnet ───┐   │              │         │
│  │  │  │  - ECS Fargate       │   │              │         │
│  │  │  │  - Lambda            │   │              │         │
│  │  │  └──────────────────────┘   │              │         │
│  │  │                              │              │         │
│  │  │  ┌─── Data Subnet ──────┐   │              │         │
│  │  │  │  - RDS (Primary)     │   │              │         │
│  │  │  │  - ElastiCache       │   │              │         │
│  │  │  └──────────────────────┘   │              │         │
│  │  └──────────────────────────────┘              │         │
│  │                                                │         │
│  │  ┌──── Availability Zone B ────┐              │         │
│  │  │  (同様の構成 - Multi-AZ)      │              │         │
│  │  └──────────────────────────────┘              │         │
│  │                                                │         │
│  └────────────────────────────────────────────────┘         │
│                                                             │
│  ┌─── グローバルサービス（リージョン外） ──┐               │
│  │  - CloudFront (CDN)                      │               │
│  │  - Route 53 (DNS)                        │               │
│  │  - S3 (写真ストレージ)                   │               │
│  │  - CloudWatch (監視)                     │               │
│  │  - IAM (権限管理)                        │               │
│  └──────────────────────────────────────────┘               │
└───────────────────────────────────────────────────────────┘

┌─────────── 外部サービス ──────────┐
│  - Auth0 (認証)                   │
│  - Datadog (監視・ログ)           │
│  - Sentry (エラー追跡)            │
│  - GitHub (コード管理・CI/CD)     │
└───────────────────────────────────┘
```

---

## 4. 各層の詳細設計

### 4.1 クライアント層

#### 4.1.1 PWA (Progressive Web App)

**技術スタック**:
- **フレームワーク**: React 18 + TypeScript
- **UIライブラリ**: Material-UI (MUI) v5
- **状態管理**:
  - React Query (サーバー状態)
  - Zustand (ローカル状態)
- **PWA**: Workbox 7
- **ビルドツール**: Vite

**オフライン対応**:
```javascript
// Service Worker戦略
{
  '/api/*': NetworkFirst,        // APIは常に最新取得
  '/photos/*': CacheFirst,        // 写真はキャッシュ優先
  '/static/*': StaleWhileRevalidate, // 静的ファイル
  '/': NetworkFirst               // HTMLは常に最新
}
```

**IndexedDB活用**:
- オフライン時の写真一時保存
- アップロード待ちキュー管理
- 最大容量: 500MB

#### 4.1.2 モバイル対応

**レスポンシブデザイン**:
- Breakpoints: 360px (Mobile), 768px (Tablet), 1024px (Desktop)
- Mobile-First設計

**カメラ機能**:
- HTML5 Camera API活用
- GPS位置情報自動取得（Geolocation API）
- EXIF情報保持

---

### 4.2 アプリケーション層

#### 4.2.1 API Server (ECS Fargate)

**技術スタック**:
- **フレームワーク**: NestJS 10 + TypeScript
- **ORM**: Prisma 5
- **バリデーション**: class-validator + class-transformer
- **ドキュメント**: Swagger (OpenAPI 3.0)

**コンテナ仕様**:
```yaml
CPU: 0.5 vCPU
Memory: 1GB
Min Instances: 2 (Multi-AZ)
Max Instances: 10 (Auto Scaling)
Health Check: /health (15秒間隔)
```

**Auto Scaling設定**:
- CPU利用率 > 70% でスケールアウト
- CPU利用率 < 30% でスケールイン
- 最小2インスタンス（Multi-AZ）
- 最大10インスタンス

**主要エンドポイント**:
```
POST   /api/v1/auth/login           # ログイン
GET    /api/v1/photos                # 写真一覧
POST   /api/v1/photos                # 写真アップロード
GET    /api/v1/projects              # 案件一覧
GET    /api/v1/schedules/:id/gantt   # Ganttデータ取得
POST   /api/v1/costs                 # 原価実績登録
GET    /api/v1/reports/cost/:id      # 原価レポート
```

#### 4.2.2 Lambda (非同期処理)

| 関数名 | トリガー | 処理内容 | タイムアウト |
|--------|---------|---------|-------------|
| **photo-thumbnail** | S3 Upload | サムネイル生成 | 30秒 |
| **photo-metadata** | S3 Upload | EXIF抽出、GPS変換 | 30秒 |
| **report-generator** | SQS | PDF/Excelレポート生成 | 5分 |
| **email-notification** | EventBridge | メール通知 | 30秒 |
| **data-backup** | EventBridge (日次) | RDSスナップショット | 5分 |

**メモリ割当**:
- 画像処理: 1,024MB
- レポート生成: 2,048MB
- その他: 512MB

---

### 4.3 データ層

#### 4.3.1 RDS (PostgreSQL)

**仕様**:
- **エンジン**: PostgreSQL 15
- **インスタンス**: db.t3.medium (Phase1) → db.r6g.large (Phase2-3)
- **ストレージ**: 100GB (汎用SSD) → Auto Scaling (最大500GB)
- **Multi-AZ**: 有効（自動フェイルオーバー）
- **バックアップ**: 日次自動（7日間保持）
- **暗号化**: 有効（AWS KMS）

**拡張機能**:
- **PostGIS**: GPS座標管理
- **pg_trgm**: 全文検索
- **pgcrypto**: 暗号化関数

**接続プール**:
- **Pgbouncer** (ECS上で稼働)
- Pool Mode: Transaction
- Max Connections: 100

#### 4.3.2 ElastiCache (Redis)

**用途**:
- セッション管理
- APIレスポンスキャッシュ
- レート制限カウンター
- 写真一覧キャッシュ

**仕様**:
- **ノードタイプ**: cache.t3.micro (Phase1) → cache.r6g.large (Phase2-3)
- **クラスターモード**: 無効（Phase1-2）、有効（Phase3）
- **TTL**: 用途別（セッション: 24h、キャッシュ: 1h）

#### 4.3.3 S3 (写真ストレージ)

**バケット構成**:
```
cdcp-photos-{env}/
├── original/           # オリジナル写真
├── thumbnail/          # サムネイル（自動生成）
├── reports/            # 生成レポート
└── exports/            # 電子納品データ
```

**ライフサイクルポリシー**:
- オリジナル: 標準ストレージ → 90日後 Glacier
- サムネイル: 標準ストレージ（削除なし）
- レポート: 30日後削除
- エクスポート: 7日後削除

**バージョニング**: 有効（誤削除対策）

---

### 4.4 外部サービス層

#### 4.4.1 Auth0 (認証)

**機能**:
- SSO (Single Sign-On)
- MFA (多要素認証): SMS / Authenticator App
- ソーシャルログイン（Phase3で顧客向け）
- RBAC (Role-Based Access Control)

**統合方式**:
- **プロトコル**: OpenID Connect (OIDC)
- **トークン**: JWT (Access Token: 1日、Refresh Token: 30日)
- **認可フロー**: Authorization Code Flow + PKCE

**ロール定義**:
- system_admin（システム管理者）
- branch_admin（拠点管理者）
- supervisor（現場監督）
- worker（作業員）
- viewer（閲覧専用）

#### 4.4.2 Datadog (監視)

**監視項目**:
- **インフラ**: CPU、メモリ、ディスク、ネットワーク
- **アプリケーション**: APM（Application Performance Monitoring）
- **ログ**: 集中ログ管理
- **RUM**: Real User Monitoring（Phase2以降）

**アラート設定**:
| メトリクス | 閾値 | 通知先 |
|-----------|------|--------|
| API Error Rate | > 5% | IT部門 + ベンダー |
| API Latency (p95) | > 2秒 | ベンダー |
| CPU使用率 | > 80% | ベンダー |
| RDS接続数 | > 80 | IT部門 + ベンダー |
| ディスク使用率 | > 80% | IT部門 |

#### 4.4.3 Sentry (エラー追跡)

**機能**:
- JavaScript/TypeScript エラー追跡
- スタックトレース記録
- ユーザー影響範囲分析
- リリース追跡

**統合**:
- フロントエンド: @sentry/react
- バックエンド: @sentry/node
- Source Map アップロード

---

## 5. セキュリティアーキテクチャ

### 5.1 多層防御

```
┌──────────────────────────────────────────────┐
│ Layer 7: アプリケーション層                   │
│  - 入力バリデーション                         │
│  - SQLインジェクション対策（Prisma ORM）       │
│  - XSS対策（React自動エスケープ）             │
│  - CSRF対策（SameSite Cookie）                │
└───────────────┬──────────────────────────────┘
                │
┌───────────────▼──────────────────────────────┐
│ Layer 6: 認証・認可層                         │
│  - Auth0 MFA                                 │
│  - JWT検証                                    │
│  - RBAC（ロールベース権限）                   │
│  - API Key管理（Phase3）                      │
└───────────────┬──────────────────────────────┘
                │
┌───────────────▼──────────────────────────────┐
│ Layer 5: ネットワーク層                       │
│  - AWS WAF（SQLi/XSS検知）                    │
│  - DDoS対策（AWS Shield）                     │
│  - レート制限（API Gateway）                  │
└───────────────┬──────────────────────────────┘
                │
┌───────────────▼──────────────────────────────┐
│ Layer 4: インフラ層                           │
│  - VPC分離（Public/Private/Data Subnet）      │
│  - Security Group（最小権限）                 │
│  - Network ACL                                │
└───────────────┬──────────────────────────────┘
                │
┌───────────────▼──────────────────────────────┐
│ Layer 3: データ層                             │
│  - RDS暗号化（KMS）                           │
│  - S3暗号化（SSE-S3）                         │
│  - バックアップ暗号化                         │
└───────────────┬──────────────────────────────┘
                │
┌───────────────▼──────────────────────────────┐
│ Layer 2: 通信層                               │
│  - TLS 1.3                                    │
│  - HTTPS強制                                  │
│  - Certificate Manager                        │
└───────────────┬──────────────────────────────┘
                │
┌───────────────▼──────────────────────────────┐
│ Layer 1: 監査層                               │
│  - CloudTrail（全API操作記録）                │
│  - アプリケーション監査ログ                   │
│  - アクセスログ（ALB、CloudFront）            │
└──────────────────────────────────────────────┘
```

### 5.2 データ暗号化

| データ種別 | 保存時暗号化 | 転送時暗号化 |
|-----------|-------------|-------------|
| **RDS** | AES-256 (KMS) | TLS 1.3 |
| **S3写真** | SSE-S3 | HTTPS (TLS 1.3) |
| **ElastiCache** | At-Rest Encryption | TLS |
| **バックアップ** | AES-256 | TLS 1.3 |
| **ログ** | CloudWatch暗号化 | TLS 1.3 |

### 5.3 アクセス制御

**IAMロール設計**:
- **最小権限原則**: 必要最小限の権限のみ付与
- **Service Role**: ECS、Lambda専用ロール
- **AssumeRole**: クロスアカウントアクセス（本番/検証）

**Network分離**:
- Public Subnet: ALB、NAT Gatewayのみ
- Private Subnet: ECS、Lambda（インターネット直接アクセス不可）
- Data Subnet: RDS、ElastiCache（アプリ層からのみアクセス可）

---

## 6. 可用性・信頼性設計

### 6.1 高可用性構成

| コンポーネント | 可用性設計 | 目標稼働率 |
|--------------|-----------|-----------|
| **ALB** | Multi-AZ | 99.99% |
| **ECS Fargate** | 2タスク以上（Multi-AZ） | 99.9% |
| **RDS** | Multi-AZ（自動フェイルオーバー） | 99.95% |
| **ElastiCache** | Multi-AZ（レプリカ） | 99.9% |
| **S3** | 3AZ自動レプリケーション | 99.99% |
| **CloudFront** | グローバルエッジ | 99.9% |

**全体目標稼働率**: 99.5%（Phase1-2）、99.9%（Phase3）

### 6.2 障害復旧設計

#### RTO/RPO目標

| Phase | RTO (目標復旧時間) | RPO (目標復旧時点) |
|-------|-------------------|-------------------|
| **Phase1-2** | 4時間 | 1日 |
| **Phase3** | 2時間 | 1時間 |

#### 自動復旧機能

| 障害シナリオ | 検知 | 自動復旧 | 復旧時間 |
|------------|------|---------|---------|
| **ECSタスク停止** | ヘルスチェック | 自動再起動 | 1分 |
| **RDSマスター障害** | Multi-AZ | 自動フェイルオーバー | 1-2分 |
| **AZ障害** | Multi-AZ | 別AZへ切替 | 2-5分 |
| **Lambda障害** | 自動リトライ | 最大3回リトライ | 数秒 |

#### バックアップ戦略

| 対象 | 頻度 | 保持期間 | リストア時間 |
|------|------|---------|-------------|
| **RDS** | 日次自動 | 7日間 | 30分 |
| **S3写真** | バージョニング | 無期限 | 即時 |
| **設定ファイル** | Git管理 | 無期限 | 5分 |

---

## 7. パフォーマンス設計

### 7.1 性能目標

| 指標 | Phase1 | Phase2 | Phase3 |
|------|--------|--------|--------|
| **同時接続ユーザー** | 50名 | 500名 | 1,000名 |
| **API応答時間（p95）** | 2秒 | 2秒 | 1秒 |
| **写真アップロード** | 3秒/枚 | 3秒/枚 | 2秒/枚 |
| **Ganttチャート表示** | - | 2秒 | 1秒 |
| **レポート生成** | - | 10秒 | 5秒 |

### 7.2 性能最適化戦略

#### キャッシング戦略

| データ種別 | キャッシュ層 | TTL | 無効化タイミング |
|-----------|------------|-----|----------------|
| **ユーザー情報** | Redis | 1時間 | ユーザー更新時 |
| **写真一覧** | Redis | 5分 | 写真追加時 |
| **マスタデータ** | Redis | 1日 | マスタ更新時 |
| **静的アセット** | CloudFront | 1年 | デプロイ時 |
| **API レスポンス** | Redis | 5分 | データ更新時 |

#### データベース最適化

- **インデックス戦略**:
  - 検索条件項目（project_id、user_id、created_at）
  - 複合インデックス（project_id + created_at）
  - GiST インデックス（GPS座標）
- **パーティショニング**:
  - 写真テーブル: 月別パーティション（Phase2以降）
  - 原価テーブル: 年度別パーティション（Phase2以降）
- **Connection Pooling**: Pgbouncer（最大100接続）

#### 画像最適化

- **サムネイル自動生成**: Lambda（アップロード時）
- **フォーマット**: WebP変換（ブラウザ対応時）
- **解像度**: サムネイル 200px、表示用 800px、オリジナル保持
- **CDN配信**: CloudFront経由

---

## 8. スケーラビリティ設計

### 8.1 水平スケール戦略

| コンポーネント | スケール方式 | トリガー |
|--------------|-------------|---------|
| **ECS Fargate** | Auto Scaling | CPU > 70% |
| **Lambda** | 自動並列実行 | リクエスト数 |
| **RDS Read Replica** | 手動追加 | Read負荷増加時（Phase3） |
| **ElastiCache** | Cluster Mode | データ量増加（Phase3） |

### 8.2 データ増加予測

| Phase | ユーザー数 | 案件数（累積） | 写真枚数（累積） | DBサイズ |
|-------|-----------|---------------|----------------|---------|
| **Phase1** | 42名 | 2件 | 5千枚 | 5GB |
| **Phase2** | 418名 | 100件 | 40万枚 | 50GB |
| **Phase3** | 500+名 | 300件 | 120万枚 | 150GB |

**対応策**:
- RDSストレージ自動拡張（最大500GB）
- S3は容量無制限
- パーティショニング導入（Phase2）

---

## 9. 運用アーキテクチャ

### 9.1 デプロイ戦略

**Blue-Green Deployment**:
```
1. 新バージョン（Green）をデプロイ
2. ヘルスチェック確認
3. ALBターゲットグループをGreenに切替
4. 旧バージョン（Blue）を10分間保持（ロールバック用）
5. Blue削除
```

**ロールバック時間**: 1分以内

### 9.2 監視・ログ戦略

#### ログ収集

| ログ種別 | 収集先 | 保持期間 | 用途 |
|---------|--------|---------|------|
| **アプリケーションログ** | CloudWatch Logs | 30日 | デバッグ、監査 |
| **アクセスログ** | S3 | 1年 | 監査、分析 |
| **監査ログ** | CloudWatch Logs | 3年 | コンプライアンス |
| **エラーログ** | Sentry + CloudWatch | 30日 | 障害対応 |

#### メトリクス監視

- **インフラ**: Datadog Agent（CPU、メモリ、ディスク、ネットワーク）
- **APM**: Datadog APM（API応答時間、エラー率）
- **RUM**: Datadog RUM（ユーザー体験）（Phase2以降）
- **カスタムメトリクス**: アップロード成功率、検索実行回数

### 9.3 IT部門運用負荷

| 運用業務 | Phase1 | Phase2 | Phase3 | 自動化手段 |
|---------|--------|--------|--------|-----------|
| **日次監視** | 30分 | 30分 | 30分 | Datadogアラート |
| **バックアップ確認** | 10分 | 10分 | 10分 | EventBridge通知 |
| **ユーザーサポート** | 2時間 | 5時間 | 3時間 | FAQ、ヘルプデスク |
| **デプロイ** | 30分/月 | 30分/月 | 30分/月 | GitHub Actions |
| **インシデント対応** | 1時間/月 | 2時間/月 | 2時間/月 | ベンダーエスカレーション |

**合計**: 週10時間以内（Phase1）、週15時間以内（Phase2-3）

---

## 10. コスト見積もり

### 10.1 月額ランニングコスト（AWS）

#### Phase1（42名）

| サービス | 仕様 | 月額コスト |
|---------|------|-----------|
| **ECS Fargate** | 2タスク × 0.5vCPU × 1GB | ¥6,000 |
| **RDS** | db.t3.medium Multi-AZ | ¥25,000 |
| **ElastiCache** | cache.t3.micro | ¥3,000 |
| **S3 + CloudFront** | 5,000枚 × 5MB + 転送 | ¥5,000 |
| **ALB** | 基本料金 + LCU | ¥3,000 |
| **Lambda** | 1万実行/月 | ¥500 |
| **Data Transfer** | 100GB/月 | ¥1,500 |

**Phase1合計**: 約¥44,000/月

#### Phase2（418名）

| サービス | 仕様 | 月額コスト |
|---------|------|-----------|
| **ECS Fargate** | 4タスク × 1vCPU × 2GB | ¥30,000 |
| **RDS** | db.r6g.large Multi-AZ | ¥60,000 |
| **ElastiCache** | cache.r6g.large | ¥20,000 |
| **S3 + CloudFront** | 40万枚 × 5MB + 転送 | ¥80,000 |
| **ALB** | 基本料金 + LCU | ¥5,000 |
| **Lambda** | 10万実行/月 | ¥3,000 |
| **Data Transfer** | 500GB/月 | ¥7,500 |

**Phase2合計**: 約¥205,500/月

#### Phase3（500+名）

**Phase3合計**: 約¥300,000/月（Phase2 + WAF + 顧客ポータル追加）

### 10.2 外部サービスコスト

| サービス | Phase1 | Phase2 | Phase3 |
|---------|--------|--------|--------|
| **Auth0** | ¥10,000/月 | ¥30,000/月 | ¥50,000/月 |
| **Datadog** | ¥20,000/月 | ¥50,000/月 | ¥80,000/月 |
| **Sentry** | ¥5,000/月 | ¥10,000/月 | ¥15,000/月 |
| **GitHub Enterprise** | ¥30,000/月 | ¥30,000/月 | ¥30,000/月 |

**外部サービス合計**: Phase1 ¥65,000/月、Phase2 ¥120,000/月、Phase3 ¥175,000/月

### 10.3 総ランニングコスト

| Phase | AWS | 外部サービス | 合計 | 年額 |
|-------|-----|-------------|------|------|
| **Phase1** | ¥44,000 | ¥65,000 | **¥109,000/月** | **¥131万円/年** |
| **Phase2** | ¥205,500 | ¥120,000 | **¥325,500/月** | **¥391万円/年** |
| **Phase3** | ¥300,000 | ¥175,000 | **¥475,000/月** | **¥570万円/年** |

**投資回収**: 年間効果1.65億円 ÷ 年額570万円 = **約3ヶ月で回収**

---

## 11. 技術的負債管理

### 11.1 意図的な技術的負債

| 項目 | Phase1-2での簡易実装 | Phase3での改善 |
|------|---------------------|---------------|
| **検索** | PostgreSQL全文検索 | Elasticsearch導入 |
| **キャッシュ** | 単純TTLキャッシュ | キャッシュ無効化戦略精緻化 |
| **モニタリング** | 基本メトリクスのみ | RUM、トレーシング追加 |

### 11.2 技術的負債の返済計画

- **Phase2終了時**: 検索性能レビュー、必要に応じてElasticsearch検討
- **Phase3開始時**: セキュリティ診断、脆弱性修正
- **運用フェーズ**: 四半期ごとのリファクタリング期間設定

---

## 12. 変更履歴

| 日付 | 版数 | 変更内容 | 変更者 |
|------|------|---------|--------|
| 2026-02-15 | 1.0 | 初版作成 | アーキテクト |

---

**承認**:
- アーキテクト: _______________
- PM: _______________
- IT部門長: _______________
