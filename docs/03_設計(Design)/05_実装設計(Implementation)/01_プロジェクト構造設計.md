# CDCP プロジェクト構造設計書

**バージョン**: 1.0
**作成日**: 2026-02-15
**対象フェーズ**: Phase1
**レビュー担当**: Architecture Review Agent

---

## 1. 文書概要

### 1.1 目的
本文書は、CDCP（Construction Digital Control Platform）のPhase1実装におけるプロジェクト構造、ディレクトリレイアウト、モジュール構成を定義する。

### 1.2 対象読者
- バックエンド開発者
- フロントエンド開発者
- プロジェクトマネージャー
- QAエンジニア

---

## 2. モノレポ構成

### 2.1 モノレポ採用理由

**採用判断基準**:
- フロントエンド・バックエンドで型定義を共有
- 統一されたCI/CDパイプライン
- IT部門の管理負荷軽減（単一リポジトリ）
- Phase1規模（2-3名体制）での開発効率

**採用ツール**: **Turborepo**
- 理由: 高速ビルド、キャッシング、並列タスク実行

### 2.2 リポジトリ全体構造

```
cdcp-monorepo/
├── apps/                          # アプリケーション
│   ├── api/                       # NestJSバックエンド
│   ├── web/                       # React PWAフロントエンド
│   └── mobile/                    # (Phase3) React Native (将来)
├── packages/                      # 共有パッケージ
│   ├── shared-types/              # 型定義共有
│   ├── ui-components/             # UIコンポーネントライブラリ
│   └── utils/                     # 共通ユーティリティ
├── infrastructure/                # インフラコード
│   ├── terraform/                 # AWS環境構築
│   ├── docker/                    # Docker構成
│   └── kubernetes/                # (Phase3) K8s構成
├── docs/                          # ドキュメント
│   ├── 01_企画・要件定義/
│   ├── 02_開発フェーズ/
│   ├── 03_設計/
│   ├── 04_運用・保守/
│   └── 05_プロジェクト管理/
├── scripts/                       # ビルド・デプロイスクリプト
│   ├── setup/                     # 環境セットアップ
│   ├── deploy/                    # デプロイスクリプト
│   └── migration/                 # データ移行
├── .github/                       # GitHub Actions CI/CD
│   └── workflows/
│       ├── api-ci.yml
│       ├── web-ci.yml
│       └── deploy.yml
├── .husky/                        # Gitフック（pre-commit等）
├── package.json                   # ルートpackage.json
├── turbo.json                     # TurboRepo設定
├── tsconfig.base.json             # 共通TypeScript設定
└── README.md
```

---

## 3. バックエンド構造（NestJS）

### 3.1 ディレクトリ構造

```
apps/api/
├── src/
│   ├── main.ts                    # エントリーポイント
│   ├── app.module.ts              # ルートモジュール
│   ├── config/                    # 設定
│   │   ├── database.config.ts
│   │   ├── aws.config.ts
│   │   ├── auth.config.ts
│   │   └── app.config.ts
│   ├── common/                    # 共通機能
│   │   ├── decorators/            # カスタムデコレーター
│   │   ├── filters/               # 例外フィルター
│   │   ├── guards/                # 認証ガード
│   │   ├── interceptors/          # インターセプター
│   │   ├── pipes/                 # バリデーションパイプ
│   │   └── middleware/            # ミドルウェア
│   ├── modules/                   # 機能モジュール
│   │   ├── auth/                  # 認証・認可
│   │   │   ├── auth.module.ts
│   │   │   ├── auth.controller.ts
│   │   │   ├── auth.service.ts
│   │   │   ├── strategies/
│   │   │   │   └── jwt.strategy.ts
│   │   │   └── dto/
│   │   │       ├── login.dto.ts
│   │   │       └── token-response.dto.ts
│   │   ├── users/                 # ユーザー管理
│   │   │   ├── users.module.ts
│   │   │   ├── users.controller.ts
│   │   │   ├── users.service.ts
│   │   │   ├── users.repository.ts
│   │   │   ├── entities/
│   │   │   │   └── user.entity.ts
│   │   │   └── dto/
│   │   │       ├── create-user.dto.ts
│   │   │       └── update-user.dto.ts
│   │   ├── organizations/         # 組織管理
│   │   │   └── ...
│   │   ├── projects/              # 案件管理
│   │   │   ├── projects.module.ts
│   │   │   ├── projects.controller.ts
│   │   │   ├── projects.service.ts
│   │   │   ├── projects.repository.ts
│   │   │   ├── entities/
│   │   │   │   ├── project.entity.ts
│   │   │   │   └── project-member.entity.ts
│   │   │   └── dto/
│   │   │       ├── create-project.dto.ts
│   │   │       ├── update-project.dto.ts
│   │   │       └── project-response.dto.ts
│   │   ├── photos/                # 写真管理（Phase1コア機能）
│   │   │   ├── photos.module.ts
│   │   │   ├── photos.controller.ts
│   │   │   ├── photos.service.ts
│   │   │   ├── photos.repository.ts
│   │   │   ├── photo-upload.service.ts
│   │   │   ├── photo-processing.service.ts
│   │   │   ├── entities/
│   │   │   │   ├── photo.entity.ts
│   │   │   │   ├── photo-folder.entity.ts
│   │   │   │   ├── photo-tag.entity.ts
│   │   │   │   └── photo-comment.entity.ts
│   │   │   └── dto/
│   │   │       ├── upload-photo.dto.ts
│   │   │       ├── photo-query.dto.ts
│   │   │       └── photo-response.dto.ts
│   │   ├── schedules/             # 工程管理（Phase2）
│   │   │   └── ...
│   │   ├── costs/                 # 原価管理（Phase2）
│   │   │   └── ...
│   │   └── health/                # ヘルスチェック
│   │       ├── health.controller.ts
│   │       └── health.service.ts
│   ├── database/                  # データベース関連
│   │   ├── migrations/            # マイグレーション
│   │   ├── seeds/                 # シードデータ
│   │   └── prisma/
│   │       └── schema.prisma      # Prismaスキーマ
│   └── integration/               # 外部連携
│       ├── aws/                   # AWS SDK統合
│       │   ├── s3.service.ts
│       │   └── ses.service.ts
│       └── auth0/                 # Auth0統合
│           └── auth0.service.ts
├── test/                          # テスト
│   ├── unit/                      # 単体テスト
│   ├── integration/               # 結合テスト
│   └── e2e/                       # E2Eテスト
├── dist/                          # ビルド出力（Git除外）
├── node_modules/                  # 依存関係（Git除外）
├── .env                           # 環境変数（Git除外）
├── .env.example                   # 環境変数サンプル
├── package.json
├── tsconfig.json
├── nest-cli.json
└── README.md
```

### 3.2 レイヤーアーキテクチャ

```
┌─────────────────────────────────────────┐
│        Presentation Layer               │
│    (Controllers, DTOs, Guards)          │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│        Application Layer                │
│     (Services, UseCases)                │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         Domain Layer                    │
│  (Entities, Domain Services)            │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Infrastructure Layer               │
│ (Repositories, External Services)       │
└─────────────────────────────────────────┘
```

**レイヤー責務**:

| レイヤー | 責務 | NestJS対応 |
|---------|-----|-----------|
| **Presentation** | HTTPリクエスト処理、バリデーション、認可 | Controllers, DTOs, Guards |
| **Application** | ビジネスロジック、トランザクション管理 | Services |
| **Domain** | ドメインモデル、ドメインロジック | Entities, Domain Services |
| **Infrastructure** | データ永続化、外部API呼び出し | Repositories, AWS Services |

### 3.3 モジュール依存関係

```
AppModule
├── ConfigModule (グローバル)
├── DatabaseModule (グローバル)
├── AuthModule
│   └─┬─ UsersModule
│     └─ JwtModule
├── UsersModule
│   └── OrganizationsModule
├── ProjectsModule
│   ├── UsersModule
│   └── OrganizationsModule
├── PhotosModule (Phase1コア)
│   ├── ProjectsModule
│   ├── UsersModule
│   └── AwsModule (S3)
└── HealthModule
```

**依存関係ルール**:
- 上位モジュールは下位モジュールに依存可能
- 下位モジュールは上位モジュールに依存不可（循環依存防止）
- 共通モジュール（Config, Database）はグローバルモジュールとして提供

---

## 4. フロントエンド構造（React PWA）

### 4.1 ディレクトリ構造

```
apps/web/
├── public/                        # 静的ファイル
│   ├── manifest.json              # PWAマニフェスト
│   ├── sw.js                      # Service Worker（ビルド時生成）
│   ├── icons/                     # アプリアイコン
│   └── offline.html               # オフライン時表示HTML
├── src/
│   ├── main.tsx                   # エントリーポイント
│   ├── App.tsx                    # ルートコンポーネント
│   ├── routes/                    # ルーティング
│   │   ├── index.tsx              # ルート定義
│   │   ├── PrivateRoute.tsx       # 認証ルート
│   │   └── routes.config.ts       # ルート設定
│   ├── pages/                     # ページコンポーネント
│   │   ├── auth/
│   │   │   ├── LoginPage.tsx
│   │   │   └── CallbackPage.tsx   # Auth0コールバック
│   │   ├── dashboard/
│   │   │   └── DashboardPage.tsx
│   │   ├── projects/
│   │   │   ├── ProjectListPage.tsx
│   │   │   ├── ProjectDetailPage.tsx
│   │   │   └── CreateProjectPage.tsx
│   │   ├── photos/                # Phase1コア
│   │   │   ├── PhotoListPage.tsx
│   │   │   ├── PhotoUploadPage.tsx
│   │   │   ├── PhotoDetailPage.tsx
│   │   │   └── PhotoMapPage.tsx   # GPS地図表示
│   │   └── settings/
│   │       └── SettingsPage.tsx
│   ├── features/                  # 機能別コンポーネント
│   │   ├── auth/
│   │   │   ├── components/
│   │   │   │   └── LoginForm.tsx
│   │   │   ├── hooks/
│   │   │   │   └── useAuth.ts
│   │   │   └── services/
│   │   │       └── authService.ts
│   │   ├── photos/
│   │   │   ├── components/
│   │   │   │   ├── PhotoCard.tsx
│   │   │   │   ├── PhotoGrid.tsx
│   │   │   │   ├── PhotoUploader.tsx
│   │   │   │   ├── CameraCapture.tsx
│   │   │   │   └── PhotoFilter.tsx
│   │   │   ├── hooks/
│   │   │   │   ├── usePhotoUpload.ts
│   │   │   │   ├── usePhotoQuery.ts
│   │   │   │   └── useGeolocation.ts
│   │   │   └── services/
│   │   │       ├── photoService.ts
│   │   │       └── indexedDbService.ts
│   │   └── projects/
│   │       ├── components/
│   │       │   ├── ProjectCard.tsx
│   │       │   └── ProjectSelector.tsx
│   │       ├── hooks/
│   │       │   └── useProjects.ts
│   │       └── services/
│   │           └── projectService.ts
│   ├── components/                # 共通コンポーネント
│   │   ├── layout/
│   │   │   ├── Header.tsx
│   │   │   ├── Sidebar.tsx
│   │   │   ├── Footer.tsx
│   │   │   └── MainLayout.tsx
│   │   ├── ui/
│   │   │   ├── Button.tsx
│   │   │   ├── Input.tsx
│   │   │   ├── Card.tsx
│   │   │   ├── Modal.tsx
│   │   │   └── Loading.tsx
│   │   └── error/
│   │       ├── ErrorBoundary.tsx
│   │       └── ErrorFallback.tsx
│   ├── hooks/                     # グローバルフック
│   │   ├── useOnline.ts           # オンライン状態監視
│   │   ├── useLocalStorage.ts
│   │   └── useDebounce.ts
│   ├── store/                     # 状態管理（Zustand）
│   │   ├── authStore.ts           # 認証状態
│   │   ├── projectStore.ts        # 選択中案件
│   │   └── offlineQueueStore.ts   # オフライン時キュー
│   ├── services/                  # APIクライアント
│   │   ├── api/
│   │   │   ├── axiosInstance.ts
│   │   │   ├── apiClient.ts
│   │   │   └── endpoints.ts
│   │   └── worker/
│   │       ├── serviceWorker.ts   # SW登録
│   │       └── workbox-config.js
│   ├── utils/                     # ユーティリティ
│   │   ├── date.ts
│   │   ├── format.ts
│   │   ├── validation.ts
│   │   └── imageCompression.ts
│   ├── types/                     # 型定義
│   │   ├── api.types.ts
│   │   ├── photo.types.ts
│   │   └── project.types.ts
│   ├── constants/                 # 定数
│   │   ├── routes.ts
│   │   ├── config.ts
│   │   └── permissions.ts
│   └── styles/                    # スタイル
│       ├── theme.ts               # MUIテーマ
│       ├── global.css
│       └── variables.css
├── .env                           # 環境変数（Git除外）
├── .env.example
├── vite.config.ts                 # Viteビルド設定
├── tsconfig.json
├── package.json
└── README.md
```

### 4.2 状態管理戦略

```
┌─────────────────────────────────────────┐
│         Server State                    │
│      (React Query)                      │
│  - API取得データ                         │
│  - キャッシング                          │
│  - 再取得制御                            │
└─────────────────────────────────────────┘
                  +
┌─────────────────────────────────────────┐
│         Client State                    │
│        (Zustand)                        │
│  - 認証状態                              │
│  - UI状態                                │
│  - オフラインキュー                      │
└─────────────────────────────────────────┘
                  +
┌─────────────────────────────────────────┐
│       Local Storage                     │
│      (IndexedDB)                        │
│  - オフライン写真                        │
│  - アップロード待ちデータ                │
└─────────────────────────────────────────┘
```

**状態管理方針**:

| 状態種別 | 管理ツール | 用途 |
|---------|-----------|-----|
| **サーバー状態** | React Query | API取得データ、キャッシング、再取得 |
| **クライアント状態** | Zustand | 認証、UI状態、グローバルフラグ |
| **永続化状態** | IndexedDB | オフラインデータ、写真一時保存 |
| **セッション状態** | LocalStorage | トークン、ユーザー設定 |

### 4.3 PWA対応構成

**Service Worker戦略**:

```javascript
// workbox-config.js
module.exports = {
  globDirectory: 'dist/',
  globPatterns: [
    '**/*.{html,js,css,png,jpg,svg,woff2}'
  ],
  swDest: 'dist/sw.js',
  runtimeCaching: [
    {
      urlPattern: /^https:\/\/api\.cdcp\.example\.com\/api\/v1\//,
      handler: 'NetworkFirst',
      options: {
        cacheName: 'api-cache',
        expiration: {
          maxEntries: 50,
          maxAgeSeconds: 300, // 5分
        },
      },
    },
    {
      urlPattern: /^https:\/\/.*\.s3\.amazonaws\.com\/.*/,
      handler: 'CacheFirst',
      options: {
        cacheName: 'photo-cache',
        expiration: {
          maxEntries: 200,
          maxAgeSeconds: 86400, // 1日
        },
      },
    },
  ],
};
```

**キャッシング戦略**:

| リソース種別 | 戦略 | 理由 |
|-----------|-----|------|
| HTML/JS/CSS | CacheFirst | 静的アセット |
| API | NetworkFirst | 最新データ優先 |
| 写真（S3） | CacheFirst | 帯域節約 |
| オフライン時 | IndexedDB | 写真一時保存 |

---

## 5. 共有パッケージ構造

### 5.1 shared-types パッケージ

```
packages/shared-types/
├── src/
│   ├── entities/                  # エンティティ型
│   │   ├── user.types.ts
│   │   ├── project.types.ts
│   │   ├── photo.types.ts
│   │   └── organization.types.ts
│   ├── dto/                       # DTO型
│   │   ├── auth.dto.ts
│   │   ├── photo.dto.ts
│   │   └── project.dto.ts
│   ├── enums/                     # 列挙型
│   │   ├── role.enum.ts
│   │   ├── project-status.enum.ts
│   │   └── photo-type.enum.ts
│   └── index.ts                   # 一括エクスポート
├── package.json
└── tsconfig.json
```

**型共有メリット**:
- フロントエンド・バックエンドで型定義統一
- 型変更時の一括更新
- コンパイル時の型安全性保証

### 5.2 ui-components パッケージ（Phase2以降）

```
packages/ui-components/
├── src/
│   ├── components/
│   │   ├── Button/
│   │   ├── Input/
│   │   └── Card/
│   └── index.ts
├── package.json
└── tsconfig.json
```

---

## 6. インフラコード構造（Terraform）

```
infrastructure/terraform/
├── environments/                  # 環境別設定
│   ├── dev/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── terraform.tfvars
│   ├── staging/
│   └── production/
├── modules/                       # 再利用モジュール
│   ├── vpc/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── ecs/
│   ├── rds/
│   ├── s3/
│   └── cloudfront/
├── backend.tf                     # Terraform Backend設定
└── README.md
```

**環境分離戦略**:
- 開発環境（dev）: 低コスト、開発者自由
- ステージング環境（staging）: 本番同等構成
- 本番環境（production）: Multi-AZ、高可用性

---

## 7. CI/CDパイプライン構成

### 7.1 GitHub Actions ワークフロー

```
.github/workflows/
├── api-ci.yml                     # バックエンドCI
├── web-ci.yml                     # フロントエンドCI
├── deploy-dev.yml                 # 開発環境デプロイ
├── deploy-staging.yml             # ステージングデプロイ
├── deploy-production.yml          # 本番デプロイ
└── pr-check.yml                   # PR時チェック
```

### 7.2 CI/CDフロー

```
┌──────────────┐
│  Git Push    │
│  (feature/*) │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  PR作成      │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────┐
│  pr-check.yml                │
│  - Lint                       │
│  - 型チェック                 │
│  - 単体テスト                 │
│  - ビルドテスト               │
└──────┬───────────────────────┘
       │
       ▼ (承認後)
┌──────────────┐
│  main merge  │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────┐
│  deploy-dev.yml              │
│  - ビルド                     │
│  - Dockerイメージ作成         │
│  - ECRプッシュ                │
│  - ECS更新                    │
└──────┬───────────────────────┘
       │
       ▼ (手動承認)
┌──────────────────────────────┐
│  deploy-production.yml       │
│  - Blue-Greenデプロイ         │
│  - ヘルスチェック             │
│  - 自動ロールバック           │
└──────────────────────────────┘
```

---

## 8. 開発環境セットアップ

### 8.1 必要ツール

| ツール | バージョン | 用途 |
|-------|----------|-----|
| Node.js | 20.x LTS | ランタイム |
| pnpm | 8.x | パッケージマネージャー |
| Docker | 24.x | ローカル開発環境 |
| PostgreSQL | 15.x | ローカルDB |
| AWS CLI | 2.x | AWS操作 |

### 8.2 セットアップ手順

```bash
# 1. リポジトリクローン
git clone https://github.com/company/cdcp-monorepo.git
cd cdcp-monorepo

# 2. 依存関係インストール
pnpm install

# 3. 環境変数設定
cp apps/api/.env.example apps/api/.env
cp apps/web/.env.example apps/web/.env

# 4. Dockerコンテナ起動（PostgreSQL, Redis）
docker-compose up -d

# 5. データベースマイグレーション
pnpm --filter api prisma migrate dev

# 6. 開発サーバー起動
pnpm dev
```

### 8.3 開発コマンド

```bash
# 全体
pnpm dev                           # 全アプリ開発サーバー起動
pnpm build                         # 全アプリビルド
pnpm test                          # 全テスト実行
pnpm lint                          # Lint実行

# API
pnpm --filter api dev              # APIサーバー起動
pnpm --filter api test             # APIテスト
pnpm --filter api prisma studio    # Prisma Studio起動

# Web
pnpm --filter web dev              # Webサーバー起動
pnpm --filter web build            # Web本番ビルド
```

---

## 9. コーディング規約

### 9.1 TypeScript規約

- **ファイル命名**: kebab-case（例: `user.service.ts`）
- **クラス命名**: PascalCase（例: `UserService`）
- **関数命名**: camelCase（例: `getUser`）
- **定数命名**: UPPER_SNAKE_CASE（例: `API_BASE_URL`）
- **インターフェース**: `I`プレフィックスなし（例: `User`）
- **型エイリアス**: PascalCase（例: `UserRole`）

### 9.2 コンポーネント規約（React）

- **ファイル命名**: PascalCase（例: `PhotoCard.tsx`）
- **Props型**: `ComponentNameProps`（例: `PhotoCardProps`）
- **Hooks**: `use`プレフィックス（例: `usePhotoUpload`）
- **デフォルトエクスポート**: コンポーネント本体のみ

### 9.3 Gitコミットメッセージ

```
<type>(<scope>): <subject>

<body>

<footer>
```

**type**:
- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメント
- `style`: コードフォーマット
- `refactor`: リファクタリング
- `test`: テスト追加
- `chore`: ビルド・ツール変更

**例**:
```
feat(photos): GPS自動記録機能を追加

写真アップロード時にGeolocation APIを使用して
GPS座標を自動記録する機能を実装

Closes #123
```

---

## 10. セキュリティガイドライン

### 10.1 環境変数管理

- **禁止**: `.env`ファイルのGit追跡
- **必須**: `.env.example`の提供
- **本番**: AWS Secrets Manager使用

### 10.2 認証・認可

- **JWT**: HTTPOnly Cookie推奨
- **CSRF**: SameSite=Strict設定
- **XSS**: React自動エスケープ活用
- **SQL Injection**: PrismaのORM利用（生SQL禁止）

### 10.3 依存関係管理

- **脆弱性スキャン**: `pnpm audit`定期実行
- **自動更新**: Dependabot有効化
- **固定バージョン**: `package.json`で固定

---

## 11. テスト戦略

### 11.1 テストピラミッド

```
        /\
       /E2E\          5%（重要パスのみ）
      /______\
     /        \
    /Integration\ 15%（API・DB統合）
   /____________\
  /              \
 /  Unit Tests    \ 80%（ロジック）
/__________________\
```

### 11.2 テストツール

| テスト種別 | ツール | 対象 |
|-----------|--------|-----|
| **単体テスト** | Jest | Services, Utils |
| **結合テスト** | Jest + Supertest | API Endpoints |
| **E2Eテスト** | Playwright | 重要ユーザーフロー |
| **コンポーネントテスト** | React Testing Library | Reactコンポーネント |

---

## 12. パフォーマンス最適化

### 12.1 フロントエンド

- **コード分割**: React.lazy() + Suspense
- **画像最適化**: WebP変換、遅延ローディング
- **バンドルサイズ**: Vite自動最適化

### 12.2 バックエンド

- **N+1問題**: Prismaの`include`で解決
- **キャッシング**: Redis活用
- **ページネーション**: Cursor-based pagination

---

## 13. 変更履歴

| 日付 | 版数 | 変更内容 | 変更者 |
|------|------|---------|--------|
| 2026-02-15 | 1.0 | 初版作成 | Architecture Review Agent |

---

**承認**:
- アーキテクト: _______________
- PM: _______________
