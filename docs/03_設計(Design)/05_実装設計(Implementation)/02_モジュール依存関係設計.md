# CDCP モジュール依存関係設計書

**バージョン**: 1.0
**作成日**: 2026-02-15
**対象フェーズ**: Phase1
**レビュー担当**: Architecture Review Agent

---

## 1. 文書概要

### 1.1 目的
本文書は、CDCP Phase1におけるNestJSバックエンドおよびReactフロントエンドのモジュール依存関係を定義し、循環依存防止とメンテナンス性向上を実現する。

### 1.2 設計原則

**依存性逆転の原則（DIP）**:
- 高レベルモジュールは低レベルモジュールに依存しない
- 両者とも抽象に依存する

**単一責任の原則（SRP）**:
- 1モジュール＝1責務

**開放閉鎖の原則（OCP）**:
- 拡張に対して開いている
- 修正に対して閉じている

---

## 2. バックエンドモジュール依存関係

### 2.1 全体モジュールツリー

```
AppModule (ルート)
│
├─┬ ConfigModule (グローバル)
│ └── Environment Variables
│
├─┬ DatabaseModule (グローバル)
│ └── Prisma Client
│
├─┬ AuthModule
│ ├── JwtModule
│ ├── PassportModule
│ └── UsersModule (参照のみ)
│
├─┬ UsersModule
│ ├── OrganizationsModule
│ └── RolesModule
│
├── OrganizationsModule
│
├── RolesModule
│
├─┬ ProjectsModule
│ ├── UsersModule
│ ├── OrganizationsModule
│ └── FilesModule
│
├─┬ PhotosModule (Phase1コア)
│ ├── ProjectsModule
│ ├── UsersModule
│ ├── AwsModule (S3)
│ └── FilesModule
│
├── FilesModule
│
├─┬ SchedulesModule (Phase2)
│ ├── ProjectsModule
│ └── UsersModule
│
├─┬ CostsModule (Phase2)
│ ├── ProjectsModule
│ └── UsersModule
│
├─┬ AwsModule (グローバル)
│ ├── S3Service
│ ├── SESService
│ └── CloudFrontService
│
└── HealthModule
```

### 2.2 Phase1主要モジュール依存図

```
┌─────────────────────────────────────────────────────────────┐
│                       AppModule                             │
└──────────┬─────────────────────────────────────────────┬────┘
           │                                             │
┌──────────▼────────┐                          ┌─────────▼──────┐
│  ConfigModule     │                          │ DatabaseModule │
│  (グローバル)      │                          │  (グローバル)   │
└───────────────────┘                          └────────────────┘

┌───────────────────────────────────────────────────────────────┐
│                    AuthModule                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ JwtStrategy  │  │ LocalStrategy│  │ Auth0Strategy│        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
│         └─────────────────┬────────────────┘                  │
│                           │                                   │
│                    ┌──────▼──────┐                            │
│                    │ AuthService │                            │
│                    └──────┬──────┘                            │
│                           │ 参照                               │
└───────────────────────────┼───────────────────────────────────┘
                            │
                    ┌───────▼──────┐
                    │ UsersModule  │
                    │              │
                    │ ┌──────────┐ │
                    │ │UserEntity│ │
                    │ └──────────┘ │
                    │              │
                    │ ┌──────────┐ │
                    │ │  Repo    │ │
                    │ └──────────┘ │
                    └──────┬───────┘
                           │
              ┌────────────┴────────────┐
              │                         │
    ┌─────────▼────────┐     ┌─────────▼────────┐
    │OrganizationsModule│     │  RolesModule     │
    └──────────────────┘     └──────────────────┘

┌───────────────────────────────────────────────────────────────┐
│                    ProjectsModule                             │
│                                                               │
│  ┌──────────────────────────────────────────────┐            │
│  │         ProjectsService                       │            │
│  │  - CRUD operations                            │            │
│  │  - Member management                          │            │
│  └──────────┬───────────────────────────────────┘            │
│             │                                                 │
│  ┌──────────▼──────────┐  ┌──────────────────┐              │
│  │ ProjectsRepository  │  │  ProjectEntity   │              │
│  └─────────────────────┘  └──────────────────┘              │
│                                                               │
│  依存: UsersModule, OrganizationsModule                      │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│              PhotosModule (Phase1コア機能)                     │
│                                                               │
│  ┌──────────────────────────────────────────────┐            │
│  │         PhotosController                      │            │
│  │  - GET /photos                                │            │
│  │  - POST /photos                               │            │
│  │  - GET /photos/:id                            │            │
│  │  - DELETE /photos/:id                         │            │
│  └──────────┬───────────────────────────────────┘            │
│             │                                                 │
│  ┌──────────▼──────────────────────────────────┐            │
│  │         PhotosService                        │            │
│  │  - アップロード処理                           │            │
│  │  - GPS情報抽出                                │            │
│  │  - サムネイル生成                             │            │
│  │  - タグ管理                                   │            │
│  └──────┬──────────────┬──────────────┬─────────┘            │
│         │              │              │                      │
│  ┌──────▼──────┐ ┌────▼────────┐ ┌───▼─────────┐           │
│  │PhotosRepo   │ │PhotoUpload  │ │PhotoProcess │           │
│  │             │ │Service      │ │Service      │           │
│  └─────────────┘ └─────┬───────┘ └─────────────┘           │
│                        │                                     │
│                  ┌─────▼───────┐                            │
│                  │ S3Service   │                            │
│                  │ (AwsModule) │                            │
│                  └─────────────┘                            │
│                                                               │
│  依存: ProjectsModule, UsersModule, AwsModule                │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│                    AwsModule (グローバル)                      │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  S3Service   │  │  SESService  │  │CloudFrontSvc │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│                                                               │
│  すべてのモジュールから利用可能（グローバルモジュール）         │
└───────────────────────────────────────────────────────────────┘
```

### 2.3 循環依存防止戦略

**問題**: `AuthModule` ⇄ `UsersModule` の循環依存

**解決策**:

```typescript
// ❌ 悪い例（循環依存）
@Module({
  imports: [
    UsersModule,  // AuthModuleがUsersModuleに依存
  ],
  providers: [AuthService],
  exports: [AuthService],
})
export class AuthModule {}

@Module({
  imports: [
    AuthModule,  // UsersModuleがAuthModuleに依存（循環！）
  ],
  providers: [UsersService],
  exports: [UsersService],
})
export class UsersModule {}

// ✅ 良い例（forwardRef使用）
@Module({
  imports: [
    forwardRef(() => UsersModule),
  ],
  providers: [AuthService],
  exports: [AuthService],
})
export class AuthModule {}

@Module({
  providers: [UsersService],
  exports: [UsersService],
})
export class UsersModule {}
```

**推奨**: `AuthModule`は`UsersModule`を参照のみ（書き込み不可）

---

## 3. レイヤーアーキテクチャ詳細

### 3.1 4層アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                  Presentation Layer                         │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Controller  │  │     DTO      │  │    Guard     │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  責務:                                                       │
│  - HTTPリクエスト受信                                        │
│  - DTOバリデーション                                         │
│  - 認証・認可チェック                                        │
│  - レスポンス返却                                            │
└─────────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                  Application Layer                          │
│                                                             │
│  ┌──────────────────────────────────────────────┐          │
│  │              Service                          │          │
│  │  - ビジネスロジック                            │          │
│  │  - トランザクション管理                        │          │
│  │  - 複数リポジトリの調整                        │          │
│  └──────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                    Domain Layer                             │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │   Entity     │  │Domain Service│                        │
│  │ (Prisma)     │  │              │                        │
│  └──────────────┘  └──────────────┘                        │
│                                                             │
│  責務:                                                       │
│  - ドメインモデル定義                                        │
│  - ドメインロジック                                          │
│  - ビジネスルール                                            │
└─────────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                 Infrastructure Layer                        │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Repository  │  │  External    │  │   Database   │     │
│  │              │  │   Service    │  │   (Prisma)   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  責務:                                                       │
│  - データ永続化                                              │
│  - 外部API呼び出し                                           │
│  - ファイルシステム操作                                      │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 レイヤー間依存関係ルール

```
Presentation → Application → Domain → Infrastructure
     ↑                                      │
     └──────────────────────────────────────┘
     (Dependency Injection)
```

**禁止**:
- Infrastructure → Domain
- Infrastructure → Application
- Domain → Infrastructure

**許可**:
- Presentation → Application
- Application → Domain
- Application → Infrastructure（DIによる注入）

### 3.3 実装例（PhotosModule）

```typescript
// ┌─────────────────────────────────────────┐
// │   Presentation Layer                    │
// └─────────────────────────────────────────┘

// photos.controller.ts
@Controller('photos')
@UseGuards(JwtAuthGuard)
export class PhotosController {
  constructor(private readonly photosService: PhotosService) {}

  @Post()
  async upload(
    @UploadedFile() file: Express.Multer.File,
    @Body() dto: UploadPhotoDto,
    @CurrentUser() user: User,
  ) {
    return this.photosService.uploadPhoto(file, dto, user);
  }

  @Get()
  async findAll(@Query() query: PhotoQueryDto) {
    return this.photosService.findAll(query);
  }
}

// upload-photo.dto.ts
export class UploadPhotoDto {
  @IsUUID()
  projectId: string;

  @IsOptional()
  @IsUUID()
  folderId?: string;

  @IsOptional()
  @IsArray()
  tagIds?: string[];

  @IsOptional()
  @IsString()
  memo?: string;
}

// ┌─────────────────────────────────────────┐
// │   Application Layer                     │
// └─────────────────────────────────────────┘

// photos.service.ts
@Injectable()
export class PhotosService {
  constructor(
    private readonly photosRepository: PhotosRepository,
    private readonly photoUploadService: PhotoUploadService,
    private readonly photoProcessingService: PhotoProcessingService,
    private readonly projectsRepository: ProjectsRepository,
  ) {}

  async uploadPhoto(
    file: Express.Multer.File,
    dto: UploadPhotoDto,
    user: User,
  ): Promise<Photo> {
    // 1. プロジェクト存在確認
    const project = await this.projectsRepository.findById(dto.projectId);
    if (!project) {
      throw new NotFoundException('Project not found');
    }

    // 2. S3アップロード
    const s3Key = await this.photoUploadService.uploadToS3(file);

    // 3. GPS情報抽出
    const gpsData = await this.photoProcessingService.extractGPS(file);

    // 4. サムネイル生成（非同期）
    this.photoProcessingService.generateThumbnail(s3Key);

    // 5. DB保存
    return this.photosRepository.create({
      ...dto,
      s3Key,
      gpsData,
      uploadedBy: user.id,
    });
  }

  async findAll(query: PhotoQueryDto): Promise<Photo[]> {
    return this.photosRepository.findMany(query);
  }
}

// ┌─────────────────────────────────────────┐
// │   Domain Layer                          │
// └─────────────────────────────────────────┘

// photo.entity.ts (Prismaスキーマから自動生成)
export interface Photo {
  id: string;
  projectId: string;
  s3Key: string;
  thumbnailS3Key?: string;
  fileName: string;
  takenAt: Date;
  locationPoint?: {
    latitude: number;
    longitude: number;
  };
  uploadedBy: string;
  createdAt: Date;
  updatedAt: Date;
}

// ┌─────────────────────────────────────────┐
// │   Infrastructure Layer                  │
// └─────────────────────────────────────────┘

// photos.repository.ts
@Injectable()
export class PhotosRepository {
  constructor(private readonly prisma: PrismaService) {}

  async create(data: CreatePhotoData): Promise<Photo> {
    return this.prisma.photo.create({
      data: {
        ...data,
        locationPoint: data.gpsData
          ? {
              type: 'Point',
              coordinates: [data.gpsData.longitude, data.gpsData.latitude],
            }
          : undefined,
      },
    });
  }

  async findMany(query: PhotoQueryDto): Promise<Photo[]> {
    return this.prisma.photo.findMany({
      where: {
        projectId: query.projectId,
        folderId: query.folderId,
        takenAt: {
          gte: query.startDate,
          lte: query.endDate,
        },
      },
      include: {
        tags: true,
        folder: true,
      },
      orderBy: { takenAt: 'desc' },
      take: query.limit || 100,
      skip: query.offset || 0,
    });
  }
}

// photo-upload.service.ts
@Injectable()
export class PhotoUploadService {
  constructor(private readonly s3Service: S3Service) {}

  async uploadToS3(file: Express.Multer.File): Promise<string> {
    const key = `photos/${Date.now()}-${file.originalname}`;
    await this.s3Service.putObject({
      bucket: process.env.S3_BUCKET_NAME,
      key,
      body: file.buffer,
      contentType: file.mimetype,
    });
    return key;
  }
}
```

---

## 4. フロントエンドモジュール依存関係

### 4.1 機能モジュール構成

```
App Component
│
├─┬ AuthFeature
│ ├── LoginPage
│ ├── CallbackPage
│ ├── useAuth hook
│ └── authService
│
├─┬ ProjectsFeature
│ ├── ProjectListPage
│ ├── ProjectDetailPage
│ ├── ProjectCard component
│ ├── useProjects hook
│ └── projectService
│
├─┬ PhotosFeature (Phase1コア)
│ ├── PhotoListPage
│ ├── PhotoUploadPage
│ ├── PhotoDetailPage
│ ├── PhotoMapPage
│ ├── Components
│ │   ├── PhotoCard
│ │   ├── PhotoGrid
│ │   ├── PhotoUploader
│ │   └── CameraCapture
│ ├── Hooks
│ │   ├── usePhotoUpload
│ │   ├── usePhotoQuery
│ │   └── useGeolocation
│ └── Services
│     ├── photoService
│     └── indexedDbService
│
└── Shared
    ├── Layout Components
    ├── UI Components
    └── Common Hooks
```

### 4.2 依存関係図

```
┌─────────────────────────────────────────────────────────────┐
│                       App.tsx                               │
└──────────────────┬──────────────────────────────────────────┘
                   │
         ┌─────────┴─────────┐
         │                   │
┌────────▼──────┐   ┌────────▼──────┐
│  AuthProvider │   │ QueryClient   │
│  (Context)    │   │ (React Query) │
└────────┬──────┘   └────────┬──────┘
         │                   │
         └─────────┬─────────┘
                   │
         ┌─────────▼─────────┐
         │     Routes        │
         │   (React Router)  │
         └─────────┬─────────┘
                   │
    ┌──────────────┼──────────────┐
    │              │              │
┌───▼────┐  ┌──────▼──────┐  ┌───▼────┐
│ Auth   │  │  Projects   │  │ Photos │
│ Pages  │  │   Pages     │  │ Pages  │
└───┬────┘  └──────┬──────┘  └───┬────┘
    │              │              │
┌───▼────────┐  ┌──▼──────────┐  ┌▼──────────────┐
│useAuth     │  │useProjects  │  │usePhotoUpload │
│(Zustand)   │  │(React Query)│  │(React Query)  │
└───┬────────┘  └──┬──────────┘  └┬──────────────┘
    │              │              │
┌───▼────────┐  ┌──▼──────────┐  ┌▼──────────────┐
│authService │  │projectService│ │photoService   │
└───┬────────┘  └──┬──────────┘  └┬──────────────┘
    │              │              │
    └──────────────┴──────────────┘
                   │
         ┌─────────▼─────────┐
         │   API Client      │
         │   (Axios)         │
         └───────────────────┘
```

### 4.3 状態管理アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                  Global State (Zustand)                     │
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  authStore   │  │ projectStore │  │offlineQueue  │     │
│  │              │  │              │  │   Store      │     │
│  │ - user       │  │ - selected   │  │ - queue[]    │     │
│  │ - token      │  │ - projects[] │  │ - sync()     │     │
│  │ - login()    │  │ - select()   │  │              │     │
│  │ - logout()   │  │              │  │              │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              Server State (React Query)                     │
│                                                             │
│  ┌──────────────────────────────────────────────┐          │
│  │  useQuery('photos', fetchPhotos, {           │          │
│  │    staleTime: 5 * 60 * 1000,                 │          │
│  │    cacheTime: 30 * 60 * 1000,                │          │
│  │  })                                          │          │
│  └──────────────────────────────────────────────┘          │
│                                                             │
│  ┌──────────────────────────────────────────────┐          │
│  │  useMutation(uploadPhoto, {                  │          │
│  │    onSuccess: () => queryClient.invalidate() │          │
│  │  })                                          │          │
│  └──────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│           Local Storage (IndexedDB)                         │
│                                                             │
│  DB: 'cdcp-offline'                                         │
│  ├── Store: 'photos' (一時保存写真)                         │
│  ├── Store: 'uploadQueue' (アップロード待ち)                │
│  └── Store: 'settings' (ユーザー設定)                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 共有パッケージ依存関係

### 5.1 shared-types 依存関係

```
apps/api/
  ├─ imports: @cdcp/shared-types
  └─ 使用箇所: DTOs, Controllers

apps/web/
  ├─ imports: @cdcp/shared-types
  └─ 使用箇所: Services, Components

packages/shared-types/
  └─ no dependencies (独立)
```

**型共有例**:

```typescript
// packages/shared-types/src/entities/photo.types.ts
export interface Photo {
  id: string;
  projectId: string;
  fileName: string;
  s3Key: string;
  takenAt: Date;
  locationPoint?: {
    latitude: number;
    longitude: number;
  };
  uploadedBy: string;
}

// apps/api/src/modules/photos/dto/photo-response.dto.ts
import { Photo } from '@cdcp/shared-types';

export class PhotoResponseDto implements Photo {
  // 型安全性が保証される
}

// apps/web/src/features/photos/services/photoService.ts
import { Photo } from '@cdcp/shared-types';

export const fetchPhotos = async (): Promise<Photo[]> => {
  // 型安全性が保証される
};
```

---

## 6. 依存関係管理ツール

### 6.1 依存関係可視化

```bash
# NestJS依存関係可視化
npx madge --circular --extensions ts src/

# 循環依存検出
npx dpdm --circular src/**/*.ts

# 依存関係ツリー表示
pnpm list --depth=2
```

### 6.2 依存関係検証（CI/CD）

```yaml
# .github/workflows/dependency-check.yml
name: Dependency Check

on: [pull_request]

jobs:
  check-circular:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
      - run: pnpm install
      - name: Check circular dependencies
        run: pnpm --filter api exec madge --circular --extensions ts src/
```

---

## 7. アンチパターンと対策

### 7.1 循環依存

❌ **悪い例**:

```typescript
// users.module.ts
@Module({
  imports: [AuthModule],  // UsersがAuthに依存
})
export class UsersModule {}

// auth.module.ts
@Module({
  imports: [UsersModule],  // AuthがUsersに依存（循環！）
})
export class AuthModule {}
```

✅ **良い例**:

```typescript
// auth.module.ts
@Module({
  imports: [forwardRef(() => UsersModule)],
})
export class AuthModule {}

// users.module.ts
@Module({
  // AuthModuleをimportしない
})
export class UsersModule {}
```

### 7.2 God Module（神モジュール）

❌ **悪い例**:

```typescript
// common.module.ts
@Module({
  imports: [
    UsersModule,
    ProjectsModule,
    PhotosModule,
    // ...すべてのモジュール
  ],
})
export class CommonModule {}
```

✅ **良い例**:

```typescript
// 各モジュールは必要最小限の依存のみ
@Module({
  imports: [UsersModule],  // 必要なモジュールのみ
})
export class ProjectsModule {}
```

### 7.3 レイヤー違反

❌ **悪い例**:

```typescript
// photos.repository.ts (Infrastructure Layer)
import { PhotosService } from './photos.service';  // Application Layerに依存（NG）

export class PhotosRepository {
  constructor(private service: PhotosService) {}
}
```

✅ **良い例**:

```typescript
// photos.service.ts (Application Layer)
import { PhotosRepository } from './photos.repository';  // Infrastructure Layerを注入（OK）

export class PhotosService {
  constructor(private repository: PhotosRepository) {}
}
```

---

## 8. 変更履歴

| 日付 | 版数 | 変更内容 | 変更者 |
|------|------|---------|--------|
| 2026-02-15 | 1.0 | 初版作成 | Architecture Review Agent |

---

**承認**:
- アーキテクト: _______________
- 開発リーダー: _______________
